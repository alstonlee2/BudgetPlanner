@page "/"
@rendermode InteractiveServer
@attribute [Authorize]
@using BudgetPlanner1.Data
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<BudgetPlanner1Context> DbFactory
@inject IJSRuntime JS

<PageTitle>Dashboard</PageTitle>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary">Financial Overview</h2>
        <span class="badge bg-light text-dark p-2 shadow-sm">Updated: @DateTime.Now.ToString("MMM dd, yyyy")</span>
    </div>

    @if (HasError)
    {
        <div class="alert alert-custom-danger shadow-sm border-0 d-flex align-items-center" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>
                <strong>Oops!</strong> @ErrorMessage
            </div>
        </div>
    }
    else
    {
        <div class="row g-4 mb-5">
            <div class="col-md-3">
                <div class="stat-card p-4 shadow-sm h-100">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted fw-semibold">Total Budget</span>
                        <i class="bi bi-wallet2 text-primary fs-4"></i>
                    </div>
                    <h3 class="fw-bold mt-2">@TotalBudget.ToString("C0")</h3>
                    <div class="progress mt-3" style="height: 6px;">
                        <div class="progress-bar bg-primary" style="width: 100%"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card p-4 shadow-sm h-100">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted fw-semibold">Total Expenses</span>
                        <i class="bi bi-cart-check text-danger fs-4"></i>
                    </div>
                    <h3 class="fw-bold mt-2">@TotalExpenses.ToString("C0")</h3>
                    @{
                        var expensePercent = TotalBudget > 0 ? (TotalExpenses / TotalBudget) * 100 : 0;
                    }
                    <div class="progress mt-3" style="height: 6px;">
                        <div class="progress-bar bg-danger" style="width: @($"{expensePercent}%")"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card p-4 shadow-sm h-100">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted fw-semibold">Remaining</span>
                        <i class="bi bi-piggy-bank text-success fs-4"></i>
                    </div>
                    <h3 class="fw-bold mt-2 @(TotalBudget - TotalExpenses < 0 ? "text-danger" : "text-success")">
                        @((TotalBudget - TotalExpenses).ToString("C0"))
                    </h3>
                    <small class="text-muted">Available Funds</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card p-4 shadow-sm h-100">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted fw-semibold">Active Goals</span>
                        <i class="bi bi-flag text-warning fs-4"></i>
                    </div>
                    <h3 class="fw-bold mt-2">@GoalsCount</h3>
                    <small class="text-muted">Across all categories</small>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-5">
                <div class="chart-card p-4 shadow-sm">
                    <h5 class="fw-bold mb-4">Expenses by Category</h5>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="chart-card p-4 shadow-sm">
                    <h5 class="fw-bold mb-4">Spending Trends</h5>
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    :root {
        --primary-color: #4361ee;
        --card-bg: #ffffff;
    }

    .stat-card {
        background: var(--card-bg);
        border-radius: 16px;
        border: 1px solid rgba(0,0,0,0.05);
        transition: transform 0.2s ease;
    }

        .stat-card:hover {
            transform: translateY(-5px);
        }

    .chart-card {
        background: var(--card-bg);
        border-radius: 20px;
        border: 1px solid rgba(0,0,0,0.05);
    }

    .chart-container {
        position: relative;
        height: 320px;
        width: 100%;
    }

    .alert-custom-danger {
        background-color: #fff5f5;
        border-left: 4px solid #f44336 !important;
        color: #d32f2f;
    }
</style>

@code {
    decimal TotalBudget;
    decimal TotalExpenses;
    int GoalsCount;
    Dictionary<string, decimal> ExpenseByCategory = new();
    Dictionary<string, decimal> MonthlyExpenses = new();
    bool HasError = false;
    string ErrorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            using var context = DbFactory.CreateDbContext();

            var expenses = await context.Expenses.Include(e => e.Category).ToListAsync();
            var goals = await context.Goals.ToListAsync();

            TotalExpenses = expenses.Sum(e => e.Amount);
            TotalBudget = goals.Sum(g => g.TargetAmount);
            GoalsCount = goals.Count;

            ExpenseByCategory = expenses
                .GroupBy(e => e.Category?.Name ?? "Uncategorized")
                .ToDictionary(g => g.Key, g => g.Sum(x => x.Amount));

            var monthlyData = expenses
                .GroupBy(e => e.ExpenseDate.Month)
                .OrderBy(g => g.Key)
                .Select(g => new { Month = g.Key, Total = g.Sum(x => x.Amount) })
                .ToList();

            MonthlyExpenses = monthlyData.ToDictionary(
                x => System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetAbbreviatedMonthName(x.Month),
                x => x.Total
            );
        }
        catch (Exception ex)
        {
            HasError = true;
            ErrorMessage = $"Data Sync Error: {ex.Message}";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (HasError || !firstRender) return;

        await Task.Delay(200);

        try
        {
            await JS.InvokeVoidAsync("loadDashboardCharts",
                ExpenseByCategory.Keys.ToArray(),
                ExpenseByCategory.Values.Select(v => (double)v).ToArray(),
                MonthlyExpenses.Keys.ToArray(),
                MonthlyExpenses.Values.Select(v => (double)v).ToArray()
            );
        }
        catch (Exception ex)
        {
            Console.WriteLine($"JS Error: {ex.Message}");
        }
    }
}